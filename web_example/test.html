<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <style>
    body {
         font-family: Arial, Helvetica, sans-serif;
    }
    .btn { margin: 5px 5px 5px 5px; }
    </style>
  </head>
  <body>
    <h2>Example of wrapping CCP4 libraries (and dependencies) to Web Assembly with emscripten</h2>
    <script async type="text/javascript" src="web_example.js"></script>
    <h2>Input</h2>
    <p>All inputs are optional.
    <ul>
    <li>If a coordinate is provided then a list of ligands in the file is printed.
    <li>If a coordinate file and structure factor file are provided then a map is calculated from them (and the ligand list <em>of first file</em>).
    <li>If 2 coordinate files are provided then superpose is run using them (and the CA count is done as well).
    <li>If an MTZ file is provided then a map is calculated.
    </ul>
    <div>
    <span>Coordinate file</span>
    <input type="file" id="pdb_input" class="btn"><br />
    <span>Second coordinate file (will be superposed with first)</span>
    <input type="file" id="pdb_input2" class="btn"><br />
    <span>Structure factor file</span>
    <input type="file" id="cif_input" class="btn"><br />
    <span>MTZ file</span>
    <input type="file" id="mtz_input" class="btn"><br />
    <input type="button" class="btn" value="Load" id="load"></input>
    </div>
    <div style="width:96%; left-margin:3%; top-margin:20px;">
    <pre id="output" style="border:1px solid green; height:200px;overflow-x:auto; overflow-y:scroll;"></pre>
    <div id="example-1-output"></div>
    <div id="example-1-svgoutput"></div>
    </div>
  <script>

     window.onload = function() {
         let myWorkerPDB = new Worker('pdb_worker.js');
         let myWorkerMTZ = new Worker('mtz_worker.js');
         let myWorkerSF = new Worker('cif_pdb_worker.js');
         let myWorkerSSM = new Worker('superpose_worker.js');
         let loadButton = document.getElementById("load");
         loadButton.onclick = function() {
             const selectedFile = document.getElementById('pdb_input').files[0];
             const selectedFile2 = document.getElementById('pdb_input2').files[0];
             const cifSelectedFile = document.getElementById('cif_input').files[0];
             const mtzSelectedFile = document.getElementById('mtz_input').files[0];
             var r = new FileReader();
             var r2 = new FileReader();
             var r_cif = new FileReader();
             var r_mtz = new FileReader();
             r_mtz.onload = function(e) {
                 let contents = e.target.result;
                 myWorkerMTZ.onmessage = function(e) {
                     let result = document.getElementById("output");
                     if(e.data[0]==="output"){
                         result.innerHTML += e.data[1] + "<br />";
                     }
                     if(e.data[0]==="result"){
                         result.innerHTML += "<b>Result: " + e.data[1] + "</b><br />";
                         //This is then where we decide upon the action
                         let xmap = e.data[1];
                         console.log(xmap.cell());
                     }
                     result.scrollTop = result.scrollHeight;
                 }
                 myWorkerMTZ.postMessage([btoa(contents), mtzSelectedFile.name]);

             }
             if(mtzSelectedFile) r_mtz.readAsBinaryString(mtzSelectedFile);
             r.onload = function(e) {
                 let contents = e.target.result;

                 myWorkerPDB.onmessage = function(e) {
                     let result = document.getElementById("output");
                     if(e.data[0]==="output"){
                         result.innerHTML += e.data[1] + "<br />";
                     }
                     if(e.data[0]==="glycan_result"){
                         // This is an example. Can do better.
                         let destSvg = document.getElementById("example-1-svgoutput");
                         for(let isvg=0;isvg<Object.keys(e.data[1]).length;isvg++){
                             let svg = e.data[1][Object.keys(e.data[1])[isvg]];
                             let parser = new DOMParser();
                             let xmlDoc = parser.parseFromString(svg,"application/xml");
                             let glycanNodes = xmlDoc.getElementsByTagName("glycan");
                             //I'm going to try to sort them by chain
                             let svgDict = {};
                             for(let iglycan=0;iglycan<glycanNodes.length;iglycan++){
                                 let glycanNode = glycanNodes[iglycan];
                                 let theChain = "unk";
                                 for(let iattr=0;iattr<glycanNode.attributes.length;iattr++){
                                     if(glycanNode.attributes[iattr].name === "chain"){
                                         theChain = glycanNode.attributes[iattr].value;
                                     }
                                 }
                                 if(theChain in svgDict){
                                     svgDict[theChain].push(glycanNode);
                                 } else {
                                     svgDict[theChain] = [glycanNode];
                                 }
                             }
                             for(const chain in svgDict){
                                 for(let icg=0;icg<svgDict[chain].length;icg++){
                                     let glycanNode = svgDict[chain][icg];
                                     let graphicsNodes = glycanNode.getElementsByTagName("svg_graphics");
                                     for(let ign=0;ign<graphicsNodes.length;ign++){
                                         let graphicsNode = graphicsNodes[ign];
                                         let newSvg = (new XMLSerializer()).serializeToString(graphicsNode);
                                         destSvg.innerHTML += newSvg + Object.keys(e.data[1])[isvg] + "<br/>";
                                     }
                                 }
                             }
                         }
                     }
                     if(e.data[0]==="result"){
                         result.innerHTML += "<b>Result: " + Object.keys(e.data[1]) + "</b><br />";
                         //This is then where we decide upon the action
                         let dest = document.getElementById("example-1-output");
                         dest.innerHTML = "";
                         for(let ilig=0;ilig<Object.keys(e.data[1]).length;ilig++){
                             let svg = e.data[1][Object.keys(e.data[1])[ilig]];
                             dest.innerHTML += svg + Object.keys(e.data[1])[ilig];
                         }
                     }
                     result.scrollTop = result.scrollHeight;
                 }
                 myWorkerPDB.postMessage([contents, selectedFile.name]);
                 r_cif.onload = function(e2) {
                     let contents2 = e2.target.result;

                     myWorkerSF.onmessage = function(e) {
                         let result = document.getElementById("output");
                         if(e.data[0]==="output"){
                             result.innerHTML += e.data[1] + "<br />";
                         }
                         if(e.data[0]==="result"){
                             result.innerHTML += "<b>Result: " + e.data[1] + "</b><br />";
                             //This is then where we decide upon the action
                         }
                         result.scrollTop = result.scrollHeight;
                     }
                     myWorkerSF.postMessage([contents, selectedFile.name, contents2, cifSelectedFile.name]);
                 }
                 r2.onload = function(e3) {
                     let contents2 = e3.target.result;

                     myWorkerSSM.onmessage = function(e) {
                         let result = document.getElementById("output");
                         if(e.data[0]==="output"){
                             result.innerHTML += e.data[1] + "<br />";
                         }
                         if(e.data[0]==="result"){
                             result.innerHTML += "<b>Result: " + e.data[1] + "</b><br />";
                             //This is then where we decide upon the action
                         }
                         result.scrollTop = result.scrollHeight;
                     }
                     myWorkerSSM.postMessage([contents, selectedFile.name, contents2, selectedFile2.name]);
                 }
                 
                 if(cifSelectedFile) r_cif.readAsText(cifSelectedFile);
                 if(selectedFile2) r2.readAsText(selectedFile2);

             }
             if(selectedFile) r.readAsText(selectedFile);
         }
     }

  </script>
  </body>
</html>

